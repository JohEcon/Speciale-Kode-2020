import math
import bisect
import random
#We define a get_index function, to make it possible to get the value from a key in a dictionary range.
def get_index(p):
    lower = math.floor(p/5)*5
    return range(lower, lower+4)

#We define a class that can create list of items that can be drawn with different probabilities
class WeightedTuple(object):
    """
    >>> p = WeightedTuple({'A': 2, 'B': 1, 'C': 3})
    >>> len(p)
    6
    >>> p[0], p[1], p[2], p[3], p[4], p[5]
    ('A', 'A', 'B', 'C', 'C', 'C')
    >>> p[-1], p[-2], p[-3], p[-4], p[-5], p[-6]
    ('C', 'C', 'C', 'B', 'A', 'A')
    >>> p[6]
    Traceback (most recent call last):
    ...
    IndexError
    >>> p[-7]
    Traceback (most recent call last):
    ...
    IndexError
    """
    def __init__(self, items):
        self.indexes = []
        self.items = []
        next_index = 0
        for key in sorted(items.keys()):
            val = items[key]
            self.indexes.append(next_index)
            self.items.append(key)
            next_index += val

        self.len = next_index

    def __getitem__(self, n):
        if n < 0:
            n = self.len + n
        if n < 0 or n >= self.len:
            raise IndexError

        idx = bisect.bisect_right(self.indexes, n)
        return self.items[idx-1]

    def __len__(self):
        return self.len

#Probabilities to generate age distribution. FOLK1A
dict_age = WeightedTuple({
20	:	16816618	,
21	:	17229276	,
22	:	17826348	,
23	:	18191678	,
24	:	18970132	,
25	:	19219592	,
26	:	18695260	,
27	:	18922805	,
28	:	18300787	,
29	:	18306383	,
30	:	17767363	,
31	:	17206428	,
32	:	16478332	,
33	:	16232603	,
34	:	15860045	,
35	:	15265538	,
36	:	14941707	,
37	:	15259477	,
38	:	15141974	,
39	:	15968922	,
40	:	16221878	,
41	:	16623112	,
42	:	16495818	,
43	:	17106878	,
44	:	18452328	,
45	:	18165799	,
46	:	18056923	,
47	:	18835377	,
48	:	18555376	,
49	:	17751510	,
50	:	17631909	,
51	:	18245999	,
52	:	19414730	,
53	:	20727541	,
54	:	20011568	,
55	:	19445738	,
56	:	18957543	,
57	:	17820985	,
58	:	17240933	,
59	:	17118535	,
60	:	16304643	,
61	:	16289256	,
62	:	16043759	,
63	:	16014850	,
64	:	15634133	,
65	:	15202824	,
66	:	15296546	,
67	:	14824671	,
68	:	14422271	,
69	:	14689449	,
70	:	14409215	,
71	:	14965254	,
72	:	15628770	,
73	:	15793600	,
74	:	14869667	,
75	:	13703501	,
76	:	12304661	,
77	:	11249936	,
78	:	9644534	,
79	:	9012725	,
80	:	8213987	,

})

#List of age specific moving rates (Hansen et al. 2013)
dict_move = {
    range(20, 24):0.0352618642070509,
    range(25, 29):0.0184234701262483,
    range(30, 34):0.0110659331391373,
    range(35, 39):0.00864987447880838,
    range(40, 44):0.00602930806612689,
    range(45, 49):0.00514301283182295,
    range(50, 54):0.00426531877756064,
    range(55, 59):0.00382964301630206,
    range(60, 64):0.00382964301630206,
    range(65, 69):0.00382964301630206,
    range(70, 74):0.00210759323186027,
    range(75, 79):0.00210759323186027,
    range(80, 84):0.00210759323186027,
    range(85, 89):0.00134321224262823,
    range(90, 94):0.00134321224262823,
    range(95, 99):0.00134321224262823,
    range(100, 104):0.00134321224262823,
    range(105, 109):0.00134321224262823,
    }

# List of age specific retirement propabilities
dict_retire = {
    range(0, 67): 0.0,
    range(67, 74): 0.0000833,
    range(75, 79): 0.00052349,
    range(80, 84): 0.00094507,
    range(85, 89): 0.00173338,
    range(90, 110):0.00485965
    }

# list of age dependent income increases INDKP106
dict_income_raise = {
    range(20, 24):1107,
    range(25, 29):967,
    range(30, 34):656,
    range(35, 39):509,
    range(40, 44):233,
    range(45, 49):-53,
    range(50, 54):-222,
    range(55, 59):-378,
    range(60, 64):-856,
    range(65, 69):-214,
    range(70, 74):0,
    range(75, 79):0,
    range(80, 84):0,
    range(85, 89):0,
    range(90, 94):0,
    range(95, 99):0,
    range(100, 104):0,
    range(105, 109):0,
}

# list of age dependent chance of moving FLY
dict_move_prop = {20: 0.0334986445551435,
21: 0.0371445534574828,
22: 0.0349417486113148,
23: 0.0320916839006649,
24: 0.0303390590086952,
25: 0.0293324955881376,
26: 0.0276758794961234,
27: 0.0259551660323574,
28: 0.0243024729582979,
29: 0.0225154618954995,
30: 0.0207162224948116,
31: 0.0192463679597354,
32: 0.017799926318073,
33: 0.0163987648226476,
34: 0.0154416200656451,
35: 0.0143473511687273,
36: 0.0134333628141947,
37: 0.0125596912947781,
38: 0.0117245569426412,
39: 0.0109884759275645,
40: 0.0101632050897384,
41: 0.00976610153235535,
42: 0.00944236442197921,
43: 0.00889482613322246,
44: 0.00842993729245212,
45: 0.00814078852937805,
46: 0.00790074981476452,
47: 0.00771163696445476,
48: 0.0074996954344777,
49: 0.00734566275804283,
50: 0.00747891314869165,
51: 0.00729970416898218,
52: 0.0069893340452003,
53: 0.00675325622715151,
54: 0.00650607592616881,
55: 0.00618581020738218,
56: 0.00597671742091355,
57: 0.00557028530648651,
58: 0.00554224329553565,
59: 0.00520137549932498,
60: 0.00506785389440201,
61: 0.00482410297810687,
62: 0.00479777474780096,
63: 0.00463892931749021,
64: 0.00466792777181735,
65: 0.00469063610780807,
66: 0.00427261083039387,
67: 0.00393008659848748,
68: 0.00390606395497262,
69: 0.00388220842301612,
70: 0.00384587896814459,
71: 0.00377402711397257,
72: 0.00362763742041183,
73: 0.00364802674448983,
74: 0.00360401638153007,
75: 0.00373926281434533,
76: 0.00384024184402754,
77: 0.00385619077857258,
78: 0.00409028233615949,
79: 0.00415929560701533,
80: 0.00434958319103163,
81: 0.00464134710031594,
82: 0.00461416334696119,
83: 0.0049373414924696,
84: 0.00500533921406787,
85: 0.00548475010547356,
86: 0.00582090889007691,
87: 0.00617520965069618,
88: 0.00651668357432222,
89: 0.00658151292190357,
90: 0.00723397483626287,
91: 0.00810911252081459,
92: 0.00798802836830648,
93: 0.0085703017755081,
94: 0.00846559241673095,
95: 0.00920446967099942,
96: 0.00887410128749466,
97: 0.00964885379546021,
98: 0.0086542619304284,
99: 0.00861590249686506,
100: 0.00861590249686506,
101: 0.00861590249686506,
102: 0.00861590249686506,
103: 0.00861590249686506,
104: 0.00861590249686506,
105: 0.00861590249686506,
106: 0.00861590249686506,
107: 0.00861590249686506,
108: 0.00861590249686506,
109: 0.00861590249686506,
110: 0.00861590249686506,


    }

dict_bin_ages = [
    20, 21,	22,	23,	24,	25,	26,	27,	28,	29,	30,	31,	32,	33,	34,	35,	36,	37,	38,	39,	40,	41,	42,	43,	44,	45,	46,	47,	48,	49,	50,	51,	52,	53,	54,	55,	56,	57,	58,	59,	60,	61,	62,	63,	64,	65,	66,	67,	68,	69,	70,	71,	72,	73,	74,	75,	76,	77,	78,	79,	80,	81,	82,	83,	84,	85,	86,	87,	88,	89,	90,	91,	92,	93,	94,	95,	96,	97,	98,	99,	100,	101,	102,	103,	104,	105,	106,	107,	108,	109,	110,
    ]

dict_bin_ages2 = [20, 22, 24, 26, 28,	30,	32,	34,	36,	38,	40,	42,	44,	46,	48,	50,	52,	54,	56,	58,	60,	62,	64,	66,	68,	70,	72,	74,	76,	78,	80,	82,	84,	86,	88,	90,	92,	94,	96,	98,	100,	102,	104,	106,	108,	110
]

dict_annuity = {
1	:	0.698204134847325	,
2	:	0.697198148630135	,
3	:	0.696188809125583	,
4	:	0.695176105155985	,
5	:	0.694160025506523	,
6	:	0.693140558924871	,
7	:	0.692117694121275	,
8	:	0.691091419768355	,
9	:	0.690061724500913	,
10	:	0.689028596915927	,
11	:	0.687992025572313	,
12	:	0.686951998990875	,
13	:	0.685908505654178	,
14	:	0.684861534006363	,
15	:	0.683811072453062	,
16	:	0.682757109361237	,
17	:	0.681699633059102	,
18	:	0.680638631835953	,
19	:	0.679574093942094	,
20	:	0.67850600758855	,
21	:	0.677434360947179	,
22	:	0.676359142150339	,
23	:	0.675280339290836	,
24	:	0.674197940421803	,
25	:	0.673111933556552	,
26	:	0.672022306668405	,
27	:	0.670929047690644	,
28	:	0.669832144516269	,
29	:	0.668731584997996	,
30	:	0.66762735694799	,
31	:	0.666519448137814	,
32	:	0.665407846298264	,
33	:	0.664292539119264	,
34	:	0.663173514249675	,
35	:	0.662050759297151	,
36	:	0.660924261828157	,
37	:	0.659794009367584	,
38	:	0.658659989398796	,
39	:	0.657522189363461	,
40	:	0.656380596661352	,
41	:	0.655235198650229	,
42	:	0.654085982645715	,
43	:	0.652932935921199	,
44	:	0.651776045707618	,
45	:	0.650615299193307	,
46	:	0.649450683523954	,
47	:	0.648282185802354	,
48	:	0.647109793088362	,
49	:	0.645933492398671	,
50	:	0.644753270706643	,
51	:	0.643569114942335	,
52	:	0.642381011992153	,
53	:	0.641188948698783	,
54	:	0.639992911861117	,
55	:	0.638792888233983	,
56	:	0.637588864528098	,
57	:	0.636380827409872	,
58	:	0.635168763501239	,
59	:	0.63395265937958	,
60	:	0.63273250157751	,
61	:	0.631508276582772	,
62	:	0.630279970838024	,
63	:	0.629047570740839	,
64	:	0.627811062643311	,
65	:	0.626570432852104	,
66	:	0.625325667628286	,
67	:	0.624076753187033	,
68	:	0.622823675697676	,
69	:	0.621566421283315	,
70	:	0.620304976020938	,
71	:	0.619039325941008	,
72	:	0.617769457027486	,
73	:	0.616495355217565	,
74	:	0.615217006401617	,
75	:	0.613934396422954	,
76	:	0.612647511077705	,
77	:	0.611356336114642	,
78	:	0.610060857235012	,
79	:	0.608761060092465	,
80	:	0.607456930292782	,
81	:	0.606148453393758	,
82	:	0.604835614905075	,
83	:	0.603518400288086	,
84	:	0.602196794955716	,
85	:	0.60087078427222	,
86	:	0.59954035355313	,
87	:	0.598205488064967	,
88	:	0.596866173025191	,
89	:	0.595522393601955	,
90	:	0.594174134913961	,
91	:	0.592821382030337	,
92	:	0.591464119970443	,
93	:	0.590102333703674	,
94	:	0.58873600814934	,
95	:	0.587365128176519	,
96	:	0.585989678603764	,
97	:	0.584609644199103	,
98	:	0.583225009679772	,
99	:	0.581835759712043	,
100	:	0.580441878911078	,
101	:	0.579043351840783	,
102	:	0.577640163013587	,
103	:	0.576232296890299	,
104	:	0.574819737879934	,
105	:	0.573402470339545	,
106	:	0.571980478574001	,
107	:	0.570553746835915	,
108	:	0.569122259325375	,
109	:	0.567686000189778	,
110	:	0.566244953523747	,
111	:	0.564799103368825	,
112	:	0.563348433713394	,
113	:	0.561892928492436	,
114	:	0.560432571587407	,
115	:	0.558967346826044	,
116	:	0.557497237982124	,
117	:	0.556022228775384	,
118	:	0.554542302871308	,
119	:	0.55305744388088	,
120	:	0.551567635360488	,
121	:	0.550072860811701	,
122	:	0.548573103681055	,
123	:	0.54706834736	,
124	:	0.545558575184537	,
125	:	0.544043770435141	,
126	:	0.542523916336596	,
127	:	0.540998996057721	,
128	:	0.539468992711251	,
129	:	0.537933889353619	,
130	:	0.536393668984805	,
131	:	0.534848314548074	,
132	:	0.533297808929898	,
133	:	0.531742134959663	,
134	:	0.530181275409527	,
135	:	0.528615212994246	,
136	:	0.527043930370883	,
137	:	0.525467410138783	,
138	:	0.523885634839254	,
139	:	0.522298586955375	,
140	:	0.520706248911898	,
141	:	0.519108603074929	,
142	:	0.517505631751858	,
143	:	0.515897317191037	,
144	:	0.514283641581665	,
145	:	0.512664587053611	,
146	:	0.511040135677123	,
147	:	0.509410269462711	,
148	:	0.50777497036092	,
149	:	0.506134220262114	,
150	:	0.504488000996332	,
151	:	0.502836294332967	,
152	:	0.501179081980745	,
153	:	0.499516345587356	,
154	:	0.497848066739309	,
155	:	0.496174226961788	,
156	:	0.494494807718306	,
157	:	0.492809790410711	,
158	:	0.491119156378741	,
159	:	0.489422886900002	,
160	:	0.487720963189678	,
161	:	0.486013366400307	,
162	:	0.484300077621639	,
163	:	0.482581077880388	,
164	:	0.480856348139991	,
165	:	0.479125869300462	,
166	:	0.477389622198121	,
167	:	0.475647587605451	,
168	:	0.473899746230802	,
169	:	0.472146078718224	,
170	:	0.470386565647292	,
171	:	0.468621187532795	,
172	:	0.466849924824557	,
173	:	0.465072757907299	,
174	:	0.463289667100342	,
175	:	0.461500632657339	,
176	:	0.459705634766202	,
177	:	0.457904653548738	,
178	:	0.456097669060574	,
179	:	0.454284661290766	,
180	:	0.452465610161753	,
181	:	0.450640495528964	,
182	:	0.448809297180725	,
183	:	0.446971994837984	,
184	:	0.445128568154122	,
185	:	0.443278996714631	,
186	:	0.441423260036998	,
187	:	0.439561337570454	,
188	:	0.437693208695689	,
189	:	0.435818852724675	,
190	:	0.433938248900426	,
191	:	0.432051376396775	,
192	:	0.430158214318086	,
193	:	0.428258741699153	,
194	:	0.426352937504811	,
195	:	0.424440780629839	,
196	:	0.422522249898591	,
197	:	0.420597324064929	,
198	:	0.418665981811802	,
199	:	0.416728201751178	,
200	:	0.414783962423675	,
201	:	0.412833242298438	,
202	:	0.410876019772755	,
203	:	0.408912273172001	,
204	:	0.406941980749251	,
205	:	0.404965120685063	,
206	:	0.40298167108735	,
207	:	0.400991609990973	,
208	:	0.398994915357612	,
209	:	0.396991565075478	,
210	:	0.394981536959067	,
211	:	0.392964808748917	,
212	:	0.390941358111414	,
213	:	0.388911162638471	,
214	:	0.386874199847264	,
215	:	0.384830447180086	,
216	:	0.382779882004001	,
217	:	0.380722481610702	,
218	:	0.37865822321607	,
219	:	0.376587083960102	,
220	:	0.374509040906642	,
221	:	0.372424071043015	,
222	:	0.370332151279808	,
223	:	0.368233258450749	,
224	:	0.366127369312254	,
225	:	0.364014460543295	,
226	:	0.361894508745104	,
227	:	0.359767490440922	,
228	:	0.357633382075726	,
229	:	0.355492160015975	,
230	:	0.353343800549355	,
231	:	0.351188279884521	,
232	:	0.349025574150805	,
233	:	0.346855659397974	,
234	:	0.344678511595969	,
235	:	0.34249410663462	,
236	:	0.340302420323407	,
237	:	0.338103428391147	,
238	:	0.335897106485787	,
239	:	0.33368343017407	,
240	:	0.331462374941324	,
241	:	0.329233916191125	,
242	:	0.326998029245093	,
243	:	0.324754689342575	,
244	:	0.322503871640389	,
245	:	0.320245551212518	,
246	:	0.317979703049892	,
247	:	0.315706302060059	,
248	:	0.313425323066927	,
249	:	0.311136740810485	,
250	:	0.308840529946521	,
251	:	0.306536665046347	,
252	:	0.304225120596498	,
253	:	0.301905870998482	,
254	:	0.299578890568485	,
255	:	0.297244153537044	,
256	:	0.294901634048837	,
257	:	0.29255130616233	,
258	:	0.290193143849535	,
259	:	0.287827120995704	,
260	:	0.285453211399023	,
261	:	0.283071388770346	,
262	:	0.280681626732912	,
263	:	0.278283898822032	,
264	:	0.275878178484766	,
265	:	0.273464439079712	,
266	:	0.271042653876654	,
267	:	0.268612796056243	,
268	:	0.266174838709758	,
269	:	0.263728754838794	,
270	:	0.261274517354916	,
271	:	0.258812099079432	,
272	:	0.256341472743036	,
273	:	0.253862610985516	,
274	:	0.251375486355464	,
275	:	0.24888007130998	,
276	:	0.246376338214345	,
277	:	0.243864259341725	,
278	:	0.241343806872873	,
279	:	0.238814952895779	,
280	:	0.236277669405434	,
281	:	0.233731928303447	,
282	:	0.231177701397791	,
283	:	0.228614960402447	,
284	:	0.226043676937129	,
285	:	0.223463822526911	,
286	:	0.220875368602004	,
287	:	0.218278286497343	,
288	:	0.215672547452341	,
289	:	0.213058122610517	,
290	:	0.210434983019218	,
291	:	0.207803099629278	,
292	:	0.20516244329471	,
293	:	0.202512984772359	,
294	:	0.199854694721599	,
295	:	0.197187543704004	,
296	:	0.194511502183022	,
297	:	0.191826540523622	,
298	:	0.189132628992045	,
299	:	0.186429737755344	,
300	:	0.183717836881201	,
301	:	0.180996896337468	,
302	:	0.178266885991927	,
303	:	0.175527775611899	,
304	:	0.17277953486394	,
305	:	0.170022133313484	,
306	:	0.167255540424531	,
307	:	0.164479725559278	,
308	:	0.161694657977809	,
309	:	0.158900306837734	,
310	:	0.156096641193863	,
311	:	0.153283629997843	,
312	:	0.150461242097837	,
313	:	0.147629446238161	,
314	:	0.144788211058956	,
315	:	0.14193750509582	,
316	:	0.139077296779471	,
317	:	0.136207554435405	,
318	:	0.133328246283518	,
319	:	0.130439340437802	,
320	:	0.127540804905928	,
321	:	0.124632607588942	,
322	:	0.12171471628091	,
323	:	0.118787098668513	,
324	:	0.115849722330738	,
325	:	0.112902554738508	,
326	:	0.109945563254305	,
327	:	0.106978715131816	,
328	:	0.104001977515588	,
329	:	0.10101531744064	,
330	:	0.0980187018321125	,
331	:	0.0950120975048872	,
332	:	0.0919954711632337	,
333	:	0.088968789400445	,
334	:	0.0859320186984472	,
335	:	0.0828851254274424	,
336	:	0.0798280758455344	,
337	:	0.0767608360983503	,
338	:	0.073683372218678	,
339	:	0.070595650126076	,
340	:	0.0674976356264952	,
341	:	0.0643892944119169	,
342	:	0.0612705920599554	,
343	:	0.0581414940334905	,
344	:	0.0550019656802671	,
345	:	0.0518519722325362	,
346	:	0.048691478806646	,
347	:	0.0455204504026674	,
348	:	0.0423388519040099	,
349	:	0.0391466480770234	,
350	:	0.0359438035706131	,
351	:	0.032730282915849	,
352	:	0.0295060505255686	,
353	:	0.0262710706939876	,
354	:	0.0230253075963005	,
355	:	0.0197687252882876	,
356	:	0.0165012877059154	,
357	:	0.0132229586649351	,
358	:	0.00993370186048477	,
359	:	0.00663348086668648	,
360	:	0.00332225913624197	,
}